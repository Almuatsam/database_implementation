USE master;
GO

ALTER DATABASE CompanyDB SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
GO

DROP DATABASE CompanyDB;
GO

CREATE DATABASE CompanyDB;
GO

USE CompanyDB;
GO
CREATE TABLE DEPARTMENT (
    DNUM INT PRIMARY KEY,
    DName VARCHAR(50) UNIQUE NOT NULL
);
CREATE TABLE DEPARTMENT_LOCATIONS (
    DNUM INT,
    Location VARCHAR(50),
    PRIMARY KEY (DNUM, Location),
    FOREIGN KEY (DNUM) REFERENCES DEPARTMENT(DNUM)
);
CREATE TABLE EMPLOYEE (
    SSN CHAR(9) PRIMARY KEY,
    Fname VARCHAR(30) NOT NULL,
    Lname VARCHAR(30) NOT NULL,
    BirthDate DATE NOT NULL,
    Gender CHAR(1) CHECK (Gender IN ('M', 'F')),
    DNUM INT NOT NULL,
    SupervisorSSN CHAR(9),
    FOREIGN KEY (DNUM) REFERENCES DEPARTMENT(DNUM),
    FOREIGN KEY (SupervisorSSN) REFERENCES EMPLOYEE(SSN)
);
CREATE TABLE MANAGES (
    DNUM INT PRIMARY KEY,
    SSN CHAR(9) UNIQUE NOT NULL,
    HireDate DATE NOT NULL,
    FOREIGN KEY (DNUM) REFERENCES DEPARTMENT(DNUM),
    FOREIGN KEY (SSN) REFERENCES EMPLOYEE(SSN)
);
CREATE TABLE PROJECT (
    PNumber INT PRIMARY KEY,
    PName VARCHAR(50) NOT NULL,
    Location VARCHAR(50) NOT NULL,
    City VARCHAR(50),
    DNUM INT NOT NULL,
    FOREIGN KEY (DNUM) REFERENCES DEPARTMENT(DNUM)
);
CREATE TABLE WORKS_ON (
    ESSN CHAR(9),
    PNumber INT,
    WorkingHours DECIMAL(5,2) NOT NULL,
    PRIMARY KEY (ESSN, PNumber),
    FOREIGN KEY (ESSN) REFERENCES EMPLOYEE(SSN),
    FOREIGN KEY (PNumber) REFERENCES PROJECT(PNumber)
);
CREATE TABLE DEPENDENT (
    ESSN CHAR(9),
    DependentName VARCHAR(50),
    Gender CHAR(1) CHECK (Gender IN ('M', 'F')),
    BirthDate DATE NOT NULL,
    PRIMARY KEY (ESSN, DependentName),
    FOREIGN KEY (ESSN) REFERENCES EMPLOYEE(SSN) ON DELETE CASCADE
);

INSERT INTO DEPARTMENT (DNUM, DName)
VALUES 
(1, 'Engineering'),
(2, 'HR'),
(3, 'Finance');
INSERT INTO DEPARTMENT_LOCATIONS (DNUM, Location)
VALUES 
(1, 'Building A'),
(1, 'Building B'),
(2, 'Main Office'),
(3, 'Finance Tower');
INSERT INTO EMPLOYEE (SSN, Fname, Lname, BirthDate, Gender, DNUM, SupervisorSSN)
VALUES 
('111111111', 'Ali', 'Al-Farsi', '1990-01-01', 'M', 1, NULL),
('222222222', 'Sara', 'Al-Hinai', '1992-05-10', 'F', 1, '111111111'),
('333333333', 'Mohammed', 'Al-Busaidi', '1988-03-15', 'M', 2, NULL);
INSERT INTO MANAGES (DNUM, SSN, HireDate)
VALUES 
(1, '111111111', '2015-06-01'),
(2, '333333333', '2018-01-10');
INSERT INTO PROJECT (PNumber, PName, Location, City, DNUM)
VALUES 
(101, 'Website Redesign', 'Building A', 'Muscat', 1),
(102, 'Recruitment Drive', 'Main Office', 'Sohar', 2);
INSERT INTO WORKS_ON (ESSN, PNumber, WorkingHours)
VALUES 
('111111111', 101, 20.5),
('222222222', 101, 15.0),
('333333333', 102, 25.0);
INSERT INTO DEPENDENT (ESSN, DependentName, Gender, BirthDate)
VALUES 
('111111111', 'Omar', 'M', '2010-08-15'),
('222222222', 'Laila', 'F', '2012-11-23');

SELECT * FROM EMPLOYEE;
SELECT * FROM PROJECT;
